#!/bin/bash
set -e

# Default values
START_TEAM=${1:-1}
END_TEAM=${2:-5}
FORCE=${3:-false}

# Check if force is enabled
if [ "$FORCE" = "force" ] || [ "$FORCE" = "true" ]; then
  FORCE=true
else
  FORCE=false
fi

echo "[+] Cleaning up K3s of Health LXCs for teams $START_TEAM through $END_TEAM"
if [ "$FORCE" = true ]; then
  echo "[!] Force mode enabled - containers will be forcefully removed"
fi

if [ "$EUID" -ne 0 ]; then
  echo "Please run as root"
  exit 1
fi

echo "[+] Current team instances:"
lxc list | grep k3s-ctf-team || echo "No team instances found"


for team_id in $(seq $START_TEAM $END_TEAM); do
    echo "[+] Cleaning up Team $team_id..."
    if [ "$FORCE" = true ]; then
        # Force stop and delete
        lxc stop k3s-ctf-team$team_id --force 2>/dev/null || true
        lxc delete k3s-ctf-team$team_id --force 2>/dev/null || true
    else
        # Normal stop and delete
        lxc stop k3s-ctf-team$team_id 2>/dev/null || true
        lxc delete k3s-ctf-team$team_id 2>/dev/null || true
    fi
    echo "[+] Team $team_id cleanup completed"
done

echo "[+] Remaining team instances (if any):"
lxc list | grep k3s-ctf-team || echo "No team instances remaining"

echo "[+] Cleanup complete!"
echo "[+] Usage: $0 [START_TEAM] [END_TEAM] [force]"
