from flask import Flask, request, jsonify, render_template_string

from ollama import ChatResponse, Client

app = Flask(__name__)

client = Client(
    host='http://localhost:11434',
    timeout=5
)


@app.route('/', methods=['POST'])
def index():
    data = request.get_json()
    if not data or 'username' not in data:
        return jsonify({"error": "username parameter is required"}), 400

    try:
        response: ChatResponse = client.chat("llama:3.2", messages=[
            {
                "role": "user",
                "content": f"My name is {data['username']}. Your job is to assist me with tasks I provide you"
            }
        ])

        if not response.done:
            raise Exception("Error with chatbot")

    except Exception as e:
        template = '''<!DOCTYPE html>
<html lang="en">
 <head>
   <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
       <title>Error</title>
 </head>
 <body>
   <h1>Sorry, {}, our chatbot server is not available.</h1>
 </body>
</html>'''.format(data['username'])

        return render_template_string(template)

    return jsonify({"response": response.response})


if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0',port=8000)
